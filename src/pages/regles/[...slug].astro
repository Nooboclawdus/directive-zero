---
import ContentLayout from '../../layouts/ContentLayout.astro';
import { getCollection, render } from 'astro:content';

export async function getStaticPaths() {
  const chapters = await getCollection('regles');
  return chapters.map((entry) => ({
    params: { slug: entry.id },
    props: { entry },
  }));
}

const { entry } = Astro.props;
const { Content, headings } = await render(entry);
const base = import.meta.env.BASE_URL.replace(/\/$/, '');

const allChapters = await getCollection('regles');
const sorted = allChapters.sort((a, b) => a.data.order - b.data.order);

const currentIndex = sorted.findIndex((c) => c.id === entry.id);
const prevChapter = currentIndex > 0 ? sorted[currentIndex - 1] : null;
const nextChapter = currentIndex < sorted.length - 1 ? sorted[currentIndex + 1] : null;

const sidebarItems = sorted.map((c) => ({
  title: c.data.title,
  href: `${base}/regles/${c.id}`,
  order: c.data.order,
}));
---

<ContentLayout
  title={entry.data.title}
  description={entry.data.description}
  section="regles"
  prevPage={prevChapter ? { title: prevChapter.data.title, href: `${base}/regles/${prevChapter.id}` } : null}
  nextPage={nextChapter ? { title: nextChapter.data.title, href: `${base}/regles/${nextChapter.id}` } : null}
  sidebarItems={sidebarItems}
  headings={headings}
>
  <Content />
</ContentLayout>
